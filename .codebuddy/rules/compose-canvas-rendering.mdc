---
description: 
alwaysApply: true
enabled: true
updatedAt: 2026-02-25T10:00:00.000Z
provider: 
---

# Compose Multiplatform Canvas LaTeX ç»˜åˆ¶è§„èŒƒ

> æœ¬è§„èŒƒçš„ç›®æ ‡ï¼š**è·¨å¹³å°æ¸²æŸ“ä¸€è‡´æ€§** + **æ•°å­¦æ’ç‰ˆç¾è§‚** + **å·¥ç¨‹å¯ç»´æŠ¤æ€§**ã€‚
> é€‚ç”¨äºåŸºäº Compose Multiplatform `Canvas` + `DrawScope` çš„è‡ªå®šä¹‰ LaTeX æ¸²æŸ“å¼•æ“ã€‚

---

## 1. æ¶æ„ï¼šMeasure/Draw ä¸¤é˜¶æ®µæ¨¡å‹

### 1.1 ä¸ºä»€ä¹ˆæ˜¯ä¸¤é˜¶æ®µè€Œéä¸‰é˜¶æ®µ

ä¼ ç»Ÿ UI æ¡†æ¶é‡‡ç”¨ Measure â†’ Layout â†’ Draw ä¸‰é˜¶æ®µã€‚ä½† LaTeX æ¸²æŸ“çš„ç‰¹æ®Šæ€§åœ¨äºï¼š**å¸ƒå±€å³æµ‹é‡** â€” ä¸€ä¸ªåˆ†æ•°çš„å¸ƒå±€ä½ç½®å®Œå…¨ç”±åˆ†å­/åˆ†æ¯çš„æµ‹é‡ç»“æœå†³å®šï¼Œä¸å­˜åœ¨ç‹¬ç«‹çš„"å¸ƒå±€çº¦æŸåå•†"é˜¶æ®µã€‚å› æ­¤é‡‡ç”¨æ›´åŠ¡å®çš„ä¸¤é˜¶æ®µæ¨¡å‹ï¼š

| é˜¶æ®µ | èŒè´£ | äº§å‡º |
|------|------|------|
| **Measureï¼ˆæµ‹é‡+å¸ƒå±€ï¼‰** | é€’å½’æµ‹é‡ ASTï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å°ºå¯¸ã€åŸºçº¿ã€å†…éƒ¨å­èŠ‚ç‚¹ç›¸å¯¹ä½ç½®ï¼Œå¹¶ç”Ÿæˆç»˜åˆ¶æŒ‡ä»¤ | `NodeLayout` |
| **Drawï¼ˆç»˜åˆ¶ï¼‰** | å°† `NodeLayout` çš„ç»˜åˆ¶æŒ‡ä»¤åœ¨ç»™å®šç»å¯¹åæ ‡ä¸‹æ‰§è¡Œ | å±å¹•åƒç´  |

### 1.2 NodeLayout æ ¸å¿ƒæ•°æ®ç»“æ„

```kotlin
class NodeLayout(
    val width: Float,
    val height: Float,
    val baseline: Float,
    val draw: DrawScope.(x: Float, y: Float) -> Unit
)
```

**è®¾è®¡å†³ç­–ä¸æ³¨æ„äº‹é¡¹**ï¼š

- **ä½¿ç”¨ `class` è€Œé `data class`**ï¼š`draw` æ˜¯ lambdaï¼Œä¸å‚ä¸ `equals`/`hashCode`ã€‚å¦‚æœä½¿ç”¨ `data class`ï¼Œ`remember(layout)` ç­‰åŸºäº equality çš„ç¼“å­˜æœºåˆ¶ä¼šäº§ç”Ÿè¯¯åˆ¤ã€‚éœ€è¦é€šè¿‡ `remember` çš„ key æ˜¯äº§ç”Ÿ layout çš„è¾“å…¥ï¼ˆå¦‚ AST èŠ‚ç‚¹ + é…ç½®ï¼‰ï¼Œè€Œé layout æœ¬èº«ã€‚
- `(x, y)` æ˜¯å…ƒç´ **å·¦ä¸Šè§’**çš„ç»å¯¹ç”»å¸ƒåæ ‡ï¼Œç”±çˆ¶çº§ä¼ å…¥ã€‚
- `baseline` æ˜¯ä»é¡¶éƒ¨åˆ°åŸºçº¿çš„è·ç¦»ï¼Œå§‹ç»ˆ >= 0ã€‚

### 1.3 draw lambda ä¸­çš„åæ ‡çº¦å®š

æ‰€æœ‰å­å…ƒç´ åœ¨ draw lambda å†…çš„ç»˜åˆ¶åæ ‡å¿…é¡»æ˜¯ **`(x + relativeX, y + relativeY)`** å½¢å¼ï¼Œå…¶ä¸­ `relativeX/relativeY` æ˜¯ Measure é˜¶æ®µé¢„è®¡ç®—çš„ç›¸å¯¹åç§»ï¼š

```kotlin
// âœ… æ­£ç¡®ï¼šMeasure é˜¶æ®µè®¡ç®—ç›¸å¯¹åç§»ï¼ŒDraw é˜¶æ®µä»…åšåŠ æ³•
fun measureFraction(...): NodeLayout {
    val numLayout = measureGroup(numerator, ...)
    val denLayout = measureGroup(denominator, ...)
    // Measure é˜¶æ®µè®¡ç®—å¥½æ‰€æœ‰ç›¸å¯¹ä½ç½®
    val numRelX = (totalWidth - numLayout.width) / 2f
    val numRelY = 0f
    val lineRelY = numLayout.height + numGap
    val denRelX = (totalWidth - denLayout.width) / 2f
    val denRelY = lineRelY + lineThickness + denGap

    return NodeLayout(
        width = totalWidth,
        height = totalHeight,
        baseline = lineRelY + axisHeight,
        draw = { x, y ->
            numLayout.draw(this, x + numRelX, y + numRelY)
            drawLine(...)  // åˆ†æ•°çº¿
            denLayout.draw(this, x + denRelX, y + denRelY)
        }
    )
}
```

**ç¦æ­¢åœ¨ draw lambda ä¸­åšçš„äº‹æƒ…**ï¼š
- âŒ è°ƒç”¨ `TextMeasurer.measure()`ï¼ˆæµ‹é‡å¿…é¡»æå‰å®Œæˆï¼‰
- âŒ è¿›è¡Œ `if/when` å¹³å°åˆ¤æ–­ï¼ˆå¹³å°å·®å¼‚å¿…é¡»åœ¨ Measure é˜¶æ®µè§£å†³ï¼‰
- âŒ åˆ†é…é›†åˆï¼ˆ`listOf`, `mutableListOf` ç­‰ï¼‰
- âŒ å­—ç¬¦ä¸²æ“ä½œï¼ˆæ‹¼æ¥ã€æ ¼å¼åŒ–ã€`AnnotatedString` æ„å»ºï¼‰

**å…è®¸åœ¨ draw lambda ä¸­åšçš„äº‹æƒ…**ï¼š
- âœ… è°ƒç”¨å­ layout çš„ `draw()`
- âœ… `drawText(precomputedTextLayoutResult, ...)`
- âœ… `drawLine()` / `drawRect()` / `drawPath(precomputedPath, ...)`
- âœ… `withTransform { scale/rotate }` + ç»˜åˆ¶è°ƒç”¨
- âœ… ç®€å•çš„ç®—æœ¯ï¼ˆ`x + offset` ç­‰ï¼‰

---

## 2. è¾¹ç•Œå®‰å…¨ï¼šæœç»å†…å®¹æˆªæ–­

> **æ ¸å¿ƒç›®æ ‡**ï¼šå†…å®¹åŒºç›¸å¯¹çˆ¶å®¹å™¨æœ‰åˆç†å†…è¾¹è·ï¼›å†…å®¹åŒºå†…éƒ¨å…ƒç´ å°½å¯èƒ½ç´§è´´ï¼Œä¸æµªè´¹ç©ºé—´ã€‚
> **é“å¾‹**ï¼š`NodeLayout` çš„ `(width, height)` å¿…é¡»å®Œæ•´åŒ…å«è¯¥èŠ‚ç‚¹æ‰€æœ‰å¯èƒ½äº§ç”Ÿåƒç´ çš„åŒºåŸŸï¼ˆå¢¨æ°´è¾¹ç•Œï¼‰ï¼Œç»ä¸å…è®¸ä»»ä½•åƒç´ ç»˜åˆ¶åˆ° `[0, width] Ã— [0, height]` ä¹‹å¤–ã€‚

### 2.1 ä¸¤ç§è¾¹ç•Œçš„åŒºåˆ†

| æ¦‚å¿µ | å®šä¹‰ | ä¸¾ä¾‹ |
|------|------|------|
| **é€»è¾‘è¾¹ç•Œ (Logical Box)** | TextMeasurer è¿”å›çš„ `size`ï¼Œå³æ–‡æœ¬çš„è¡Œæ¡†å¤§å° | `TextLayoutResult.size.width/height` |
| **å¢¨æ°´è¾¹ç•Œ (Ink Bounds)** | å­—å½¢å®é™…ç»˜åˆ¶çš„åƒç´ èŒƒå›´ï¼Œå¯èƒ½è¶…å‡ºé€»è¾‘è¾¹ç•Œ | æ–œä½“ "f" å³ä¾§æ‚¬ä¼¸ã€"g" ä¸‹æ–¹çš„ descender å°¾å·´ã€å¤§æ‹¬å·é¡¶åº•ç«¯ |

**è§„åˆ™**ï¼š`NodeLayout.width/height` å¿…é¡»åŸºäº**å¢¨æ°´è¾¹ç•Œ**ï¼Œè€Œéé€»è¾‘è¾¹ç•Œã€‚

### 2.2 æ°´å¹³æ–¹å‘æº¢å‡ºçš„æ¥æºä¸è¡¥å¿

#### (a) æ–œä½“æ‚¬ä¼¸ (Italic Overhang)

æ–œä½“å­—çš„æœ€åä¸€ä¸ªå­—ç¬¦å‘å³å€¾æ–œï¼Œå…¶å¢¨æ°´å¯èƒ½è¶…å‡ºé€»è¾‘å®½åº¦ï¼›ç¬¬ä¸€ä¸ªå­—ç¬¦å¯èƒ½å‘å·¦çªå‡º x=0ã€‚

```kotlin
// âš ï¸ å…³é”®ï¼šè¡¥å¿å€¼å¿…é¡»ä½¿ç”¨ px å•ä½ï¼Œä¸èƒ½ç”¨ sp çš„æ•°å€¼ç›´æ¥åŠ åˆ° px å®½åº¦ä¸Š
val fontSizePx = with(density) { context.fontSize.toPx() }

val rightOverhang = if (context.fontStyle == FontStyle.Italic && text.isNotEmpty()) {
    when {
        text.last().isUpperCase() -> fontSizePx * 0.15f
        text.last().isLowerCase() -> fontSizePx * 0.12f
        else -> fontSizePx * 0.08f
    }
} else 0f

val leftOverhang = if (context.fontStyle == FontStyle.Italic && text.isNotEmpty()) {
    when {
        text.first() in "FTVWYfv" -> fontSizePx * 0.05f  // å‘å·¦çªå‡ºå­—ç¬¦
        else -> 0f
    }
} else 0f

// width å¿…é¡»åŒ…å«ä¸¤ä¾§æ‚¬ä¼¸
val totalWidth = logicalWidth + leftOverhang + rightOverhang

// draw æ—¶å‘å³åç§» leftOverhangï¼Œç¡®ä¿å¢¨æ°´ä¸è¶…å‡º x=0
draw = { x, y -> drawText(result, topLeft = Offset(x + leftOverhang, y)) }
```

**ä¸¥ç¦å°† `TextUnit.value`ï¼ˆsp æ•°å€¼ï¼‰ç›´æ¥åŠ åˆ°åƒç´ å€¼ä¸Š**ã€‚åœ¨ 2x/3x å¯†åº¦å±å¹•ä¸Šï¼Œè¿™ä¼šå¯¼è‡´è¡¥å¿ä¸¥é‡ä¸è¶³ã€‚

#### (b) Stroke åŠå®½æº¢å‡º

ä½¿ç”¨ `Stroke(width = W)` ç»˜åˆ¶ Path æˆ– Line æ—¶ï¼Œç¬”ç”»ä¼šå‘è·¯å¾„ä¸¤ä¾§å„æ‰©å±• `W/2`ï¼š

```kotlin
// æ ¹å· V å½¢é’©å­ â€” å®½åº¦å¿…é¡»åŒ…å« Stroke åŠå®½
val strokeHalf = strokeWidth / 2f
val totalWidth = pathRightEdge + strokeHalf  // å³ä¾§è¡¥å¿
// å¦‚æœ Path æœ€å·¦ç«¯æ˜¯ x=0ï¼Œè¿˜éœ€è¦ leftPadding = strokeHalf
// æ›´å¥½çš„åšæ³•ï¼šPath æ„å»ºæ—¶æœ€å·¦ç«¯ä» strokeHalf å¼€å§‹ï¼Œè€Œé 0
```

**è§„åˆ™**ï¼šå‡¡æ˜¯ä½¿ç”¨ `Stroke` ç»˜åˆ¶çš„ Path/Lineï¼Œå…¶ `NodeLayout.width/height` å¿…é¡»åŒ…å« `strokeWidth / 2` çš„è¾¹è·è¡¥å¿ã€‚

#### (c) å¤§å‹è¿ç®—ç¬¦çš„è§†è§‰å®½åº¦ vs glyph å®½åº¦

ç§¯åˆ†å·ç­‰é€šè¿‡ç¼©æ”¾æˆ–ç‰¹æ®Šå­—ä½“ç»˜åˆ¶çš„è¿ç®—ç¬¦ï¼Œå…¶å®é™… glyph å®½åº¦å¯èƒ½è¿œå¤§äº"è§†è§‰æœ‰æ•ˆå®½åº¦"ã€‚

```kotlin
// âŒ é”™è¯¯ï¼šç”¨"è§†è§‰å®½åº¦"ä½œä¸º layout å®½åº¦ï¼Œglyph å®é™…æ›´å®½ï¼Œå³ä¾§è¢«è£åˆ‡
val width = opVisualWidth * 1.1f

// âœ… æ­£ç¡®ï¼šå– glyph å®é™…å®½åº¦ä¸è§†è§‰å®½åº¦çš„è¾ƒå¤§å€¼
val width = max(opGlyphLayout.width, opVisualWidth)
```

### 2.3 å‚ç›´æ–¹å‘æº¢å‡ºçš„æ¥æºä¸è¡¥å¿

#### (a) scale å˜æ¢åçš„å®é™…é«˜åº¦

ä½¿ç”¨ `withTransform { scale }` å‚ç›´æ‹‰ä¼¸å…ƒç´ æ—¶ï¼Œ`NodeLayout.height` å¿…é¡»åæ˜ æ‹‰ä¼¸åçš„é«˜åº¦ï¼š

```kotlin
// âŒ é”™è¯¯ï¼šheight ä½¿ç”¨æœªç¼©æ”¾çš„é«˜åº¦ï¼Œç¼©æ”¾åä¸Šä¸‹æº¢å‡º
val height = opLayout.height  // åŸå§‹é«˜åº¦
// draw ä¸­ withTransform { scale(scaleY = 2.0f) }  â†’ å®é™…å  2x é«˜åº¦

// âœ… æ­£ç¡®ï¼šheight ä¸ºç¼©æ”¾åçš„é«˜åº¦
val height = opLayout.height * verticalScale
```

#### (b) è£…é¥°ç¬¦å·çš„ç»˜åˆ¶åç§»

é‡éŸ³ç¬¦å·ï¼ˆhat/vecï¼‰åœ¨å±…ä¸­å¯¹é½æ—¶å¯èƒ½å›  `italicCorrection` åç§»å¯¼è‡´å³ä¾§æº¢å‡ºï¼š

```kotlin
// è£…é¥°å±…ä¸­ä½ç½® = contentCenter + italicCorrection
// width å¿…é¡»å®¹çº³åç§»åçš„è£…é¥°å®Œæ•´å®½åº¦
val accentRight = contentCenterX + italicCorrection + accentWidth / 2f
val totalWidth = max(contentWidth, accentRight)
```

#### (c) å®šç•Œç¬¦ glyph æº¢å‡º

KaTeX Size å­—ä½“çš„å­—å½¢è®¾è®¡è¾ƒä¸ºè§„èŒƒï¼Œä½†åœ¨ fontSize ç¼©æ”¾å…œåº•åœºæ™¯ï¼ˆSize4 ä»ä¸å¤Ÿé«˜æ—¶ï¼‰æˆ–å¤§å‹è¿ç®—ç¬¦åœºæ™¯ä¸‹ï¼Œglyph çš„å¢¨æ°´è¾¹ç•Œä»å¯èƒ½è¶…å‡º `TextLayoutResult.size`ï¼ˆå°¤å…¶æ˜¯ descent æ–¹å‘ï¼‰ï¼š

```kotlin
// å¯¹æ”¾å¤§çš„å®šç•Œç¬¦ï¼Œæ·»åŠ ä¿å®ˆçš„å‚ç›´ä½™é‡
val verticalOverflow = if (scaleFactor > 1.5f) fontSizePx * 0.05f * scaleFactor else 0f
val totalHeight = measuredHeight + verticalOverflow * 2
```

### 2.4 å¤–å±‚ Canvas çš„å†…è¾¹è·æ¨¡å‹

NodeLayout å†…éƒ¨çš„ width/height å¿…é¡»ç²¾ç¡®åŒ…å«å¢¨æ°´è¾¹ç•Œï¼ˆ**å†…éƒ¨ç´§è´´**åŸåˆ™ï¼‰ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæœ€å¤–å±‚ Canvas æ·»åŠ ç»Ÿä¸€çš„å†…è¾¹è·ï¼Œä½¿å†…å®¹åŒºä¸çˆ¶å®¹å™¨ä¿æŒé—´è·ï¼š

```kotlin
@Composable
fun LatexDocument(layout: NodeLayout, context: RenderContext, ...) {
    val density = LocalDensity.current
    val fontSizePx = with(density) { context.fontSize.toPx() }

    // å¤–å±‚å†…è¾¹è·ï¼šå†…å®¹åŒºä¸ Canvas è¾¹ç¼˜çš„é—´è·
    val horizontalPadding = fontSizePx * 0.15f   // å·¦å³å„ 15% fontSize
    val verticalPadding = fontSizePx * 0.10f     // ä¸Šä¸‹å„ 10% fontSize

    val canvasWidth = layout.width + horizontalPadding * 2
    val canvasHeight = layout.height + verticalPadding * 2

    Canvas(modifier = Modifier.size(
        width = with(density) { canvasWidth.toDp() },
        height = with(density) { canvasHeight.toDp() }
    )) {
        // å†…å®¹ä» (horizontalPadding, verticalPadding) å¼€å§‹ç»˜åˆ¶
        layout.draw(this, horizontalPadding, verticalPadding)
    }
}
```

**è®¾è®¡ç†ç”±**ï¼š
- **æ°´å¹³å†…è¾¹è·**ï¼šè¡¥å¿æ–œä½“å­—å½¢å¯èƒ½çš„å¾®é‡æ®‹ä½™æº¢å‡º + è§†è§‰å‘¼å¸ç©ºé—´
- **å‚ç›´å†…è¾¹è·**ï¼šè¡¥å¿ descender å°¾ç«¯ã€è£…é¥°ç¬¦å·é¡¶éƒ¨ç­‰å¾®é‡æº¢å‡º + é¿å…å†…å®¹ç´§è´´ä¸Šä¸‹è¾¹ç¼˜
- å†…è¾¹è·å€¼ä¸ `fontSize` æˆæ­£æ¯”ï¼Œä¿è¯åœ¨ä¸åŒå­—å·ä¸‹è§†è§‰ä¸€è‡´

### 2.5 è¾¹ç•Œå®‰å…¨çš„åˆ†å±‚è´£ä»»

| å±‚çº§ | è´£ä»» | åšä»€ä¹ˆ |
|------|------|--------|
| **Measurerï¼ˆæ¯ä¸ªèŠ‚ç‚¹ï¼‰** | **ç²¾ç¡®å¢¨æ°´è¾¹ç•Œ** | width/height åŒ…å« Stroke åŠå®½ã€æ–œä½“æ‚¬ä¼¸ã€glyph å®é™…å¢¨æ°´èŒƒå›´ã€‚å†…éƒ¨ä¸ç•™ä½™é‡ã€‚ |
| **measureGroupï¼ˆè¡Œçº§ç»„åˆï¼‰** | **åŸºçº¿å¯¹é½æ±‡æ€»** | æ­£ç¡®è®¡ç®— maxAscent/maxDescentï¼Œä¸æ·»åŠ é¢å¤– paddingã€‚ |
| **LatexDocumentï¼ˆæœ€å¤–å±‚ï¼‰** | **ç»Ÿä¸€å†…è¾¹è·** | åœ¨ layout.width/height åŸºç¡€ä¸Šæ·»åŠ  horizontalPadding/verticalPaddingã€‚è¿™æ˜¯å”¯ä¸€æ·»åŠ "å‘¼å¸ç©ºé—´"çš„åœ°æ–¹ã€‚ |

**ç¦æ­¢**åœ¨ä¸­é—´å±‚ï¼ˆå•ä¸ª Measurer æˆ– measureGroupï¼‰æ·»åŠ "ä¿é™© padding"ã€‚å¦‚æœæŸä¸ª Measurer çš„å†…å®¹æº¢å‡ºï¼Œåº”ä¿®æ­£è¯¥ Measurer çš„å°ºå¯¸è®¡ç®—ï¼Œè€Œéåœ¨å¤–å±‚åŠ  padding æ©ç›–é—®é¢˜ã€‚

### 2.6 éªŒè¯æ–¹æ³•ï¼šè°ƒè¯•è¾¹æ¡†

å¼€å‘é˜¶æ®µå¯å¼€å¯è°ƒè¯•è¾¹æ¡†ï¼Œå¯è§†åŒ–æ¯ä¸ª NodeLayout çš„è¾¹ç•Œï¼š

```kotlin
// åœ¨ draw lambda çš„æœ€åï¼ˆæˆ–åŒ…è£…å±‚ï¼‰ç»˜åˆ¶åŠé€æ˜çº¢è‰²è¾¹æ¡†
fun DrawScope.debugBounds(x: Float, y: Float, width: Float, height: Float) {
    if (DEBUG_BOUNDS_ENABLED) {
        drawRect(
            color = Color.Red.copy(alpha = 0.3f),
            topLeft = Offset(x, y),
            size = Size(width, height),
            style = Stroke(1f)
        )
    }
}
```

å¦‚æœä»»ä½•å†…å®¹åƒç´ å‡ºç°åœ¨çº¢è‰²è¾¹æ¡†ä¹‹å¤–ï¼Œè¯´æ˜è¯¥èŠ‚ç‚¹çš„å°ºå¯¸è®¡ç®—æœ‰ bugï¼Œéœ€è¦ä¿®æ­£ã€‚

---

## 3. Path æ„å»ºç­–ç•¥ï¼šç›¸å¯¹åæ ‡ + translate

### 3.1 æ ¸å¿ƒçŸ›ç›¾ä¸è§£å†³æ–¹æ¡ˆ

Path å¯¹è±¡åŒ…å«çš„æ˜¯ç»å¯¹åæ ‡ç‚¹ï¼Œä½† draw æ—¶çš„ `(x, y)` åªåœ¨ç»˜åˆ¶æ—¶ç¡®å®šã€‚æœ‰ä¸‰ç§ç­–ç•¥ï¼š

| ç­–ç•¥ | åšæ³• | ä¼˜åŠ£ |
|------|------|------|
| **A: é¢„æ„å»º + translate** | Path ä»¥ `(0,0)` ä¸ºåŸç‚¹æ„å»ºï¼Œdraw æ—¶ç”¨ `translate(x, y)` åç§» | âœ… æ¨èï¼šPath åªåˆ›å»ºä¸€æ¬¡ï¼Œæ€§èƒ½æœ€ä¼˜ |
| B: draw æ—¶æ„å»º | æ¯æ¬¡ draw æ—¶åˆ›å»ºæ–° Path | âŒ æ¯å¸§åˆ†é…å¯¹è±¡ï¼ŒGC å‹åŠ› |
| C: Path å‚æ•°åŒ– | æŠ½è±¡ä¸ºå‡½æ•°ï¼Œä¼ å…¥ offset | âŒ è¿‡åº¦æŠ½è±¡ï¼Œå¯è¯»æ€§å·® |

### 3.2 æ ‡å‡†å†™æ³•

```kotlin
// Measure é˜¶æ®µï¼šä»¥ (0,0) ä¸ºåŸç‚¹æ„å»º Path
val sqrtPath = Path().apply {
    moveTo(0f, hookHeight)
    lineTo(hookWidth, totalHeight)       // V å½¢åº•éƒ¨
    lineTo(hookWidth + checkWidth, 0f)   // V å½¢é¡¶éƒ¨
    lineTo(totalWidth, 0f)               // æ°´å¹³é¡¶çº¿ç»ˆç‚¹
}

// Draw é˜¶æ®µï¼štranslate åˆ°å®é™…ä½ç½®åç»˜åˆ¶
draw = { x, y ->
    withTransform({ translate(left = x, top = y) }) {
        drawPath(sqrtPath, color = color, style = Stroke(strokeWidth))
    }
    contentLayout.draw(this, x + contentOffsetX, y + contentOffsetY)
}
```

### 3.3 Path å¤ç”¨ä¸å…±äº«

åŒç±»å‹ä½†ä¸åŒå°ºå¯¸çš„ Path **ä¸è¦**è¯•å›¾å¤ç”¨ï¼ˆå¦‚ä¸åŒå¤§å°çš„æ ¹å·ï¼‰ï¼Œæ¯ä¸ª NodeLayout å®ä¾‹æŒæœ‰è‡ªå·±çš„ Path å®ä¾‹ã€‚ä½†ç›¸åŒçš„ Path æ„å»ºé€»è¾‘åº”æŠ½å–ä¸ºå·¥å‚å‡½æ•°ï¼š

```kotlin
object PathFactory {
    fun createSqrtPath(hookWidth: Float, checkWidth: Float, totalWidth: Float, totalHeight: Float): Path { ... }
    fun createBracePath(width: Float, height: Float, isOver: Boolean): Path { ... }
    fun createArrowPath(width: Float, headSize: Float, direction: Direction): Path { ... }
}
```

---

## 4. æ–‡æœ¬æ¸²æŸ“ï¼šTextLayoutResult é¢„è®¡ç®—

### 4.1 æ ‡å‡†æµç¨‹

```kotlin
// Measure é˜¶æ®µ
val textLayoutResult = textMeasurer.measure(
    text = AnnotatedString(content),
    style = resolvedTextStyle   // å­—ä½“ã€å¤§å°ã€é¢œè‰²ç­‰å·²åœ¨æ­¤ç¡®å®š
)
val width = textLayoutResult.size.width.toFloat()
val height = textLayoutResult.size.height.toFloat()
val baseline = textLayoutResult.firstBaseline

// draw lambda ä¸­ â€” åªä¼ å…¥é¢„è®¡ç®—å¥½çš„ TextLayoutResult
draw = { x, y ->
    drawText(textLayoutResult, topLeft = Offset(x, y))
}
```

### 4.2 TextStyle ç¼“å­˜ç­–ç•¥

`TextStyle` åˆ›å»ºè™½ç„¶è½»é‡ä½†åœ¨é€’å½’æµ‹é‡æ•°åƒä¸ªèŠ‚ç‚¹æ—¶ç´¯ç§¯æ˜æ˜¾ã€‚åº”åœ¨ `RenderContext` ä¸­ç¼“å­˜å¸¸ç”¨æ ·å¼ï¼š

```kotlin
class RenderContext(
    val fontSize: TextUnit,
    val textColor: Color,
    val fontFamily: FontFamily,
    val fontWeight: FontWeight,
    val fontStyle: FontStyle,
    // ç¼“å­˜å¸¸ç”¨æ ·å¼å˜ä½“ï¼ˆlazy åˆå§‹åŒ–ï¼Œé¿å…æœªä½¿ç”¨æ—¶çš„å¼€é”€ï¼‰
    // ...
) {
    // å¯¹å¤–æä¾›çš„æ ·å¼è·å–æ–¹æ³•ï¼Œå†…éƒ¨å¯åšç¼“å­˜
    fun textStyle(): TextStyle = TextStyle(
        fontSize = fontSize,
        color = textColor,
        fontFamily = fontFamily,
        fontWeight = fontWeight,
        fontStyle = fontStyle,
    )
}
```

---

## 5. è·¨å¹³å°ä¸€è‡´æ€§

### 5.1 å­—ä½“ç­–ç•¥ï¼šKaTeX å†…åµŒå­—ä½“ + é›†ä¸­è·¯ç”±

**æ ¸å¿ƒåŸåˆ™**ï¼šè·¨å¹³å°ä¸€è‡´æ€§çš„æœ€å¤§æ•Œäººæ˜¯å­—ä½“å·®å¼‚ã€‚é¡¹ç›®å†…åµŒ **KaTeX å­—ä½“**ï¼ˆæ ‡å‡† Unicode ç¼–ç ï¼‰ï¼Œä½¿æ‰€æœ‰å¹³å°ä½¿ç”¨åŒä¸€å¥—å­—å½¢ï¼Œå½»åº•æ¶ˆé™¤å¹³å°å­—ä½“å¼•æ“ç¼–ç å·®å¼‚å¯¼è‡´çš„å­—å½¢é”™è¯¯ã€‚

#### å­—ä½“æ¨¡å‹ï¼šLatexFontFamilies 12 æ§½ä½

```kotlin
data class LatexFontFamilies(
    val main: FontFamily,           // KaTeX_Main â€” æ–‡æœ¬ã€è¿ç®—ç¬¦ã€å®šç•Œç¬¦
    val math: FontFamily,           // KaTeX_Math â€” æ•°å­¦æ–œä½“å˜é‡
    val ams: FontFamily,            // KaTeX_AMS â€” é»‘æ¿ç²—ä½“ â„â„•â„¤â„‚
    val sansSerif: FontFamily,      // KaTeX_SansSerif
    val monospace: FontFamily,      // KaTeX_Typewriter
    val caligraphic: FontFamily,    // KaTeX_Caligraphic
    val fraktur: FontFamily,        // KaTeX_Fraktur
    val script: FontFamily,         // KaTeX_Script
    val size1: FontFamily,          // KaTeX_Size1 â€” \big å®šç•Œç¬¦
    val size2: FontFamily,          // KaTeX_Size2 â€” \Big å®šç•Œç¬¦
    val size3: FontFamily,          // KaTeX_Size3 â€” \bigg å®šç•Œç¬¦
    val size4: FontFamily,          // KaTeX_Size4 â€” \Bigg å®šç•Œç¬¦
)
```

**12 ä¸ªæ§½ä½çš„è®¾è®¡ç†ç”±**ï¼šKaTeX çš„å®šç•Œç¬¦å­—ä½“ï¼ˆSize1~4ï¼‰åŒ…å«ç‹¬ç«‹è®¾è®¡çš„ä¸åŒå°ºå¯¸å­—å½¢ï¼Œæ¯ä¸ªå°ºå¯¸çš„ç¬”ç”»ç²—ç»†ç»è¿‡ä¸“é—¨è°ƒæ•´ï¼Œæ— éœ€ FontWeight è¡¥å¿ã€‚è¿™æ˜¯ç›¸æ¯”æ—§ CM å­—ä½“ä½“ç³»çš„æ ¸å¿ƒæ”¹è¿›ã€‚

#### ç¬¦å·è·¯ç”±ï¼šFontResolver é›†ä¸­ç®¡ç†

```kotlin
/**
 * é›†ä¸­ç®¡ç†å­—ä½“é€‰æ‹©ä¸ç¬¦å·è·¯ç”±ã€‚
 * æ‰€æœ‰å­—ä½“é€‰æ‹©é€»è¾‘å½’å£æ­¤å¤„ï¼ŒMeasurer ä¸­ç¦æ­¢ç›´æ¥é€‰æ‹©å­—ä½“ã€‚
 */
object FontResolver {
    /**
     * LaTeX å‘½ä»¤å â†’ SymbolRenderInfo æ˜ å°„è¡¨ã€‚
     * çº¦ 180+ æ¡ç›®ï¼Œè¦†ç›–å¸Œè…Šå­—æ¯ã€ç®­å¤´ã€è¿ç®—ç¬¦ã€å…³ç³»ç¬¦ã€å®šç•Œç¬¦ç­‰ã€‚
     */
    private val symbolMap: Map<String, SymbolRenderInfo> = mapOf(...)

    /**
     * FontCategory â†’ FontFamily æ˜ å°„ã€‚
     * KaTeX ä½¿ç”¨æ ‡å‡† Unicode ç¼–ç ï¼Œæ— éœ€å¹³å°ç‰¹å®šçš„å­—å½¢ç¼ºé™·æ˜ å°„ã€‚
     */
    fun resolve(category: FontCategory, fontFamilies: LatexFontFamilies?): FontFamily {
        return when (category) {
            FontCategory.ROMAN -> fontFamilies?.main
            FontCategory.MATH_ITALIC -> fontFamilies?.math
            FontCategory.SYMBOL -> fontFamilies?.main  // KaTeX: è¿ç®—ç¬¦åœ¨ Main ä¸­
            FontCategory.EXTENSION -> fontFamilies?.size1
            FontCategory.BLACKBOARD_BOLD -> fontFamilies?.ams
            FontCategory.CALLIGRAPHIC -> fontFamilies?.caligraphic
            FontCategory.FRAKTUR -> fontFamilies?.fraktur
            FontCategory.SCRIPT -> fontFamilies?.script
            // ...
        } ?: FontFamily.Default
    }

    /** å®šç•Œç¬¦å­—ä½“é€‰æ‹©ï¼šæ ¹æ®ç¼©æ”¾æ¯”ä¾‹é€‰æ‹© Size å­—ä½“ */
    fun resolveDelimiterFont(fontFamilies: LatexFontFamilies?, scale: Float): FontFamily { ... }

    /** æ‰‹åŠ¨å¤§å°å®šç•Œç¬¦ï¼š\big/\Big/\bigg/\Bigg â†’ Size1/2/3/4 ç›´æ¥æ˜ å°„ */
    fun manualDelimiterFont(fontFamilies: LatexFontFamilies?, scaleFactor: Float): FontFamily { ... }
}
```

**KaTeX vs CM å­—ä½“çš„å…³é”®å·®å¼‚**ï¼š
- **æ ‡å‡† Unicode ç¼–ç **ï¼šKaTeX å­—ä½“ä½¿ç”¨æ ‡å‡† Unicode ç ä½ï¼Œæ‰€æœ‰å¹³å°çš„å­—ä½“å¼•æ“å‡èƒ½æ­£ç¡®è§£ç ï¼Œæ— éœ€å¹³å°ç‰¹å®šçš„ `knownDefects` æ˜ å°„è¡¨
- **è¿ç®—ç¬¦åœ¨ Main å­—ä½“ä¸­**ï¼šKaTeX å°†è¿ç®—ç¬¦ã€å®šç•Œç¬¦ã€æ ‡ç‚¹ç­‰æ”¾åœ¨ `KaTeX_Main`ï¼Œè€Œéç‹¬ç«‹çš„ symbol å­—ä½“
- **4 çº§å®šç•Œç¬¦å°ºå¯¸å­—ä½“**ï¼šSize1~4 æä¾›ç‹¬ç«‹è®¾è®¡çš„å­—å½¢ï¼Œç¬”ç”»ç²—ç»†ä¸€è‡´ï¼Œå–ä»£äº†æ—§æ–¹æ¡ˆä¸­çš„ fontSize ç¼©æ”¾ + FontWeight è¡¥å¿

### 5.2 åæ ‡å•ä½

- å†…éƒ¨è®¡ç®—ç»Ÿä¸€ä½¿ç”¨ **px**
- ç”¨æˆ·é¢å‘çš„é…ç½®ä½¿ç”¨ `TextUnit`ï¼ˆspï¼‰å’Œ `Dp`
- è½¬æ¢é€šè¿‡ `Density` è¿›è¡Œï¼Œç¦æ­¢ç¡¬ç¼–ç å¯†åº¦å› å­
- `Density` åœ¨é¡¶å±‚ Composable è·å–åæ³¨å…¥åˆ° `RenderContext`ï¼Œé€’å½’è¿‡ç¨‹ä¸­ä¼ é€’åŒä¸€å®ä¾‹

### 5.3 é¢œè‰²ç®¡ç†

```kotlin
// âœ… æ‰€æœ‰é¢œè‰²ä» RenderContext è·å–
context.textColor       // ä¸»æ–‡æœ¬é¢œè‰²
context.errorColor      // é”™è¯¯å›é€€é¢œè‰²
context.lineColor       // åˆ†æ•°çº¿ã€æ ¹å·çº¿ç­‰ç»“æ„çº¿é¢œè‰²ï¼ˆé€šå¸¸ = textColorï¼‰

// âŒ ç¦æ­¢
Color.Black / Color.Red / Color(0xFF...)  // ç¡¬ç¼–ç é¢œè‰²æ— æ³•é€‚åº”æ·±è‰²æ¨¡å¼
```

é¢œè‰²åº”åœ¨æœ€å¤–å±‚ Composable æ ¹æ® `isSystemInDarkTheme()` è§£æåæ³¨å…¥ `RenderContext`ï¼Œå†…éƒ¨ç»˜åˆ¶é€»è¾‘ä¸æ„ŸçŸ¥ä¸»é¢˜ã€‚

---

## 6. åŸºçº¿å¯¹é½ç³»ç»Ÿ

### 6.1 æ°´å¹³æ’åˆ—çš„åŸºçº¿å¯¹é½ï¼ˆæ ¸å¿ƒå…¬å¼ï¼‰

å°†å¤šä¸ªå…ƒç´ æ°´å¹³æ’æˆä¸€è¡Œæ—¶ï¼š

```
// ç¬¬ä¸€éï¼šæ‰¾åˆ°ç»Ÿä¸€åŸºçº¿
maxAscent  = max(child_i.baseline)                    // æœ€å¤§ä¸Šå‡
maxDescent = max(child_i.height - child_i.baseline)   // æœ€å¤§ä¸‹é™
groupHeight = maxAscent + maxDescent
groupBaseline = maxAscent

// ç¬¬äºŒéï¼šæ¯ä¸ªå­å…ƒç´ çš„ y åç§»ï¼ˆåŸºçº¿å¯¹é½ï¼‰
childY(i) = groupY + (maxAscent - child_i.baseline)

// x æ–¹å‘é€ä¸ªæ’åˆ—
childX(i) = childX(i-1) + child_(i-1).width
```

**ä¸¥ç¦ä½¿ç”¨é¡¶éƒ¨å¯¹é½æˆ–ä¸­å¿ƒå¯¹é½æ’åˆ—è¡Œå†…å…ƒç´ **ã€‚å”¯ä¸€çš„ä¾‹å¤–æ˜¯ç‹¬ç«‹çš„å—çº§ç»“æ„ï¼ˆå¦‚å¤šè¡Œå…¬å¼çš„è¡Œé—´æ’åˆ—å¯ä½¿ç”¨ä¸­å¿ƒå¯¹é½ï¼‰ã€‚

### 6.2 æ•°å­¦è½´ (Math Axis)

æ•°å­¦è½´æ˜¯åˆ†æ•°çº¿ã€åŠ å‡å·ç­‰å…ƒç´ çš„å‚ç›´å¯¹ç§°ä¸­å¿ƒï¼Œé€šå¸¸ä½äºåŸºçº¿ä¸Šæ–¹çº¦ 0.5 Ã— x-height çš„ä½ç½®ã€‚

**è®¡ç®—æ–¹æ³•**ï¼šæµ‹é‡å­—ç¬¦ "âˆ’"ï¼ˆU+2212 MINUS SIGNï¼‰æˆ– "+" çš„å‚ç›´ä¸­å¿ƒä½ç½®ç›¸å¯¹äºåŸºçº¿çš„åç§»ï¼š

```kotlin
fun computeAxisHeight(textMeasurer: TextMeasurer, style: TextStyle): Float {
    val result = textMeasurer.measure(AnnotatedString("\u2212"), style)
    val baseline = result.firstBaseline
    val charMidY = result.size.height / 2f
    return baseline - charMidY
}
```

`axisHeight` çš„ç”¨é€”ï¼š
- **åˆ†æ•°çº¿** y åæ ‡ = elementY + baseline - axisHeight
- **å¤§å‹è¿ç®—ç¬¦**çš„å‚ç›´å±…ä¸­ç‚¹ = baseline - axisHeight
- **è‡ªåŠ¨ä¼¸ç¼©å®šç•Œç¬¦**çš„å‚ç›´å±…ä¸­ç‚¹ = å†…å®¹ baseline - axisHeight

**ç¼“å­˜**ï¼š`axisHeight` åªå–å†³äºå­—ä½“å’Œå­—å·ï¼Œåº”åœ¨ `RenderContext` ä¸­ç¼“å­˜ï¼Œé¿å…æ¯ä¸ªèŠ‚ç‚¹é‡å¤æµ‹é‡ã€‚

### 6.3 ä¸Šä¸‹æ ‡å®šä½

```
ä¸Šæ ‡é¡¶éƒ¨ä½ç½® = base.baseline - base.baseline * SUPERSCRIPT_SHIFT - sup.height
ä¸‹æ ‡é¡¶éƒ¨ä½ç½® = base.baseline + base.baseline * SUBSCRIPT_SHIFT - sub.baseline

å½“ä¸Šä¸‹æ ‡åŒæ—¶å­˜åœ¨æ—¶ï¼Œç¡®ä¿ä¸¤è€…ä¸é‡å ï¼š
  å¦‚æœ supBottom + minGap > subTopï¼Œåˆ™å‡åŒ€æ¨å¼€
```

---

## 7. æ•°å­¦æ’ç‰ˆé—´è·è§„èŒƒ

### 7.1 é—´è·ç±»å‹ï¼ˆå‚è€ƒ TeX æ ‡å‡†ï¼‰

LaTeX é—´è·çš„åº•å±‚å•ä½æ˜¯ **mu**ï¼ˆmath unitï¼‰ï¼Œ1 em = 18 muã€‚é—´è·åº”å®šä¹‰ä¸º fontSize çš„æ¯”ä¾‹ç³»æ•°ï¼š

```kotlin
object MathSpacing {
    // åŸºç¡€é—´è·ï¼ˆfontSize çš„æ¯”ä¾‹ç³»æ•°ï¼‰
    const val THIN   = 3f / 18f    // \, = 3mu  â‰ˆ 0.167em
    const val MEDIUM = 4f / 18f    // \: = 4mu  â‰ˆ 0.222em  (ä»… display/text style)
    const val THICK  = 5f / 18f    // \; = 5mu  â‰ˆ 0.278em  (ä»… display/text style)
    const val QUAD   = 1f          // \quad = 18mu = 1em
    const val NEGATIVE_THIN = -3f / 18f  // \! = -3mu

    /**
     * æ ¹æ®å·¦å³åŸå­ç±»å‹ç¡®å®šé—´è·ã€‚
     * å‚è€ƒ TeXbook Chapter 18 çš„é—´è·è§„åˆ™è¡¨ã€‚
     */
    fun spaceBetween(left: AtomType, right: AtomType, style: MathStyle): Float {
        return SPACING_TABLE[left]?.get(right)?.let { rule ->
            when (rule) {
                SpaceRule.NONE -> 0f
                SpaceRule.THIN -> THIN
                SpaceRule.MEDIUM -> if (style.isScript) 0f else MEDIUM
                SpaceRule.THICK -> if (style.isScript) 0f else THICK
            }
        } ?: 0f
    }
}
```

### 7.2 åŸå­ç±»å‹é—´è·è¡¨ï¼ˆTeX æ ‡å‡†ç®€åŒ–ç‰ˆï¼‰

| å·¦ \ å³ | Ord | Op | Bin | Rel | Open | Close | Punct |
|---------|-----|----|-----|-----|------|-------|-------|
| **Ord**   | 0 | thin | med | thick | 0 | 0 | 0 |
| **Op**    | thin | thin | - | thick | 0 | 0 | 0 |
| **Bin**   | med | med | - | - | med | - | - |
| **Rel**   | thick | thick | - | 0 | thick | 0 | 0 |
| **Open**  | 0 | 0 | - | 0 | 0 | 0 | 0 |
| **Close** | 0 | thin | med | thick | 0 | 0 | 0 |
| **Punct** | thin | thin | - | thin | thin | thin | thin |

> `-` è¡¨ç¤ºè¯¥ç»„åˆä¸åº”å‡ºç°ï¼›`med` å’Œ `thick` åœ¨ script/scriptscript æ ·å¼ä¸­é™ä¸º 0ã€‚

### 7.3 æ•°å­¦æ ·å¼ä¸ç¼©æ”¾

TeX å®šä¹‰äº† 4 ç§æ•°å­¦æ ·å¼ï¼Œå½±å“å­—å·å’Œé—´è·ï¼š

```kotlin
enum class MathStyle(val scriptLevel: Int) {
    DISPLAY(0),        // ç‹¬ç«‹è¡Œå…¬å¼ â€” å…¨å°ºå¯¸
    TEXT(0),           // è¡Œå†…å…¬å¼ â€” å…¨å°ºå¯¸
    SCRIPT(1),         // ä¸Šä¸‹æ ‡ â€” ç¼©å°
    SCRIPT_SCRIPT(2);  // ä¸Šä¸‹æ ‡çš„ä¸Šä¸‹æ ‡ â€” æ›´å°

    val isScript get() = scriptLevel > 0

    fun scaleFactor(): Float = when (this) {
        DISPLAY, TEXT -> 1.0f
        SCRIPT -> 0.7f
        SCRIPT_SCRIPT -> 0.5f
    }
}
```

**è§„åˆ™**ï¼š
- ä¸Šä¸‹æ ‡å†…å®¹ä½¿ç”¨ `SCRIPT` æ ·å¼ï¼ˆ0.7xï¼‰
- ä¸Šä¸‹æ ‡çš„ä¸Šä¸‹æ ‡ä½¿ç”¨ `SCRIPT_SCRIPT` æ ·å¼ï¼ˆ0.5xï¼‰
- `SCRIPT_SCRIPT` ä¸å†ç»§ç»­ç¼©å°ï¼ˆæœ€å°é˜ˆå€¼ï¼‰
- åˆ†æ•°çº¿ä¸Šä¸‹åœ¨ `DISPLAY` ä¸‹ä½¿ç”¨ `TEXT`ï¼Œåœ¨ `TEXT` ä¸‹ä½¿ç”¨ `SCRIPT`

---

## 8. ç¼©æ”¾ä¸å˜æ¢

### 8.1 ä½•æ—¶ä½¿ç”¨ scale vs é‡æ–°æµ‹é‡

| åœºæ™¯ | æ–¹æ¡ˆ | åŸå›  |
|------|------|------|
| ä¸Šä¸‹æ ‡ç¼©å° | **é‡æ–°æµ‹é‡**ï¼ˆç”¨æ›´å°çš„ fontSizeï¼‰ | æ–‡æœ¬æ¸…æ™°åº¦ï¼Œé¿å…æ¨¡ç³Š |
| å¤§å‹è¿ç®—ç¬¦æ”¾å¤§ | **é‡æ–°æµ‹é‡**ï¼ˆæ”¾å¤§ fontSizeï¼‰+ å¯é€‰å‚ç›´ scale | å­—ä½“å¼•æ“ä»¥ç›®æ ‡å­—å·å…‰æ …åŒ–ï¼Œè´¨é‡æœ€ä¼˜ |
| å®šç•Œç¬¦ä¼¸ç¼© | **KaTeX Size å­—ä½“é€çº§é€‰æ‹©**ï¼ˆMainâ†’Size1â†’Size2â†’Size3â†’Size4ï¼‰ | æ¯çº§å­—ä½“åŒ…å«ç‹¬ç«‹è®¾è®¡çš„å­—å½¢ï¼Œç¬”ç”»ç²—ç»†ä¸€è‡´ï¼Œæ— éœ€ FontWeight è¡¥å¿ã€‚è¯¦è§ç¬¬ 9.3 èŠ‚ |

### 8.2 scale å˜æ¢çš„ç¬”ç”»è¡¥å¿

> **æ³¨æ„**ï¼šå®šç•Œç¬¦å·²è¿ç§»åˆ° KaTeX Size å­—ä½“é€çº§é€‰æ‹©æ–¹æ¡ˆï¼Œæ— éœ€ scale å˜æ¢å’Œ FontWeight è¡¥å¿ã€‚ä»¥ä¸‹å†…å®¹ä»…é€‚ç”¨äºå¤§å‹è¿ç®—ç¬¦ç­‰ä»ä½¿ç”¨ `withTransform { scale }` çš„åœºæ™¯ã€‚

å½“ä½¿ç”¨ `scale` æ”¾å¤§æ–‡æœ¬æ—¶ï¼Œç¬”ç”»ç²—ç»†ä¼šç­‰æ¯”å˜ç²—ï¼Œè§†è§‰ä¸Šä¸è‡ªç„¶ã€‚å¿…é¡»é€šè¿‡é™ä½ `FontWeight` è¡¥å¿ï¼š

```kotlin
fun compensatedFontWeight(baseWeight: Int, scaleFactor: Float): FontWeight {
    // scaleFactor = 1.0 â†’ weight ä¸å˜
    // scaleFactor = 2.0 â†’ weight é™è‡³çº¦ 100
    // çº¿æ€§æ’å€¼ï¼Œä¸”é™åˆ¶åœ¨ [100, baseWeight] èŒƒå›´å†…
    val compensated = baseWeight - ((scaleFactor - 1.0f) * (baseWeight - 100) / 1.0f).toInt()
    return FontWeight(compensated.coerceIn(100, baseWeight))
}
```

å¯¹äº `Stroke` ç»˜åˆ¶çš„çº¿æ¡ï¼Œç›´æ¥åæ¯”è¡¥å¿ï¼š

```kotlin
fun compensatedStrokeWidth(baseStroke: Float, scaleFactor: Float): Float {
    return (baseStroke / scaleFactor).coerceAtLeast(0.5f)  // æœ€å° 0.5px é˜²æ­¢æ¶ˆå¤±
}
```

---

## 9. å­—ä½“ä½“ç³»ä¸å®šç•Œç¬¦ç»˜åˆ¶ç­–ç•¥

### 9.1 é¡¹ç›®å­—ä½“æ–‡ä»¶èƒ½åŠ›æ€»è§ˆ

é¡¹ç›®å†…åµŒ **KaTeX** ç³»åˆ—å­—ä½“ï¼ˆæ¥è‡ª [KaTeX](https://github.com/KaTeX/KaTeX) é¡¹ç›®ï¼ŒMIT è®¸å¯è¯ï¼‰ï¼Œä½¿ç”¨æ ‡å‡† Unicode ç¼–ç ã€‚å…± 20 ä¸ª TTF æ–‡ä»¶ï¼Œåˆ†å››å¤§ç±»ï¼š

#### ä¸»æ–‡æœ¬ & è¿ç®—ç¬¦å­—ä½“

| å­—ä½“æ–‡ä»¶ | æ§½ä½ | å­—é‡/æ ·å¼ | æä¾›çš„å­—å½¢ | ç”¨é€” |
|---------|------|----------|-----------|------|
| `katex_main_regular.ttf` | main (Normal) | Regular | æ‹‰ä¸å­—æ¯ã€æ•°å­—ã€æ ‡ç‚¹ã€è¿ç®—ç¬¦ã€å®šç•Œç¬¦ã€å¤§å†™å¸Œè…Šå­—æ¯ | `\text{}`ã€`\mathrm{}`ã€è¡Œå†…è¿ç®—ç¬¦ |
| `katex_main_bold.ttf` | main (Bold) | Bold | åŒä¸Šï¼ˆç²—ä½“å˜ä½“ï¼‰ | `\mathbf{}`ã€`\textbf{}` |
| `katex_main_italic.ttf` | main (Italic) | Italic | æ‹‰ä¸æ–œä½“å­—æ¯ | æ–‡æœ¬æ–œä½“ |
| `katex_main_bolditalic.ttf` | main (BoldItalic) | BoldItalic | æ‹‰ä¸ç²—æ–œä½“ | `\boldsymbol{}` æ–‡æœ¬ |

#### æ ¸å¿ƒæ•°å­¦å­—ä½“

| å­—ä½“æ–‡ä»¶ | æ§½ä½ | å­—é‡/æ ·å¼ | æä¾›çš„å­—å½¢ | å…³é”®èƒ½åŠ› |
|---------|------|----------|-----------|---------|
| **`katex_math_italic.ttf`** | math (Italic) | Italic | æ‹‰ä¸æ–œä½“å˜é‡ã€**å¸Œè…Šå­—æ¯**(Î±,Î²,Î³...) | æ•°å­¦å˜é‡çš„é»˜è®¤å­—ä½“ |
| **`katex_math_bolditalic.ttf`** | math (BoldItalic) | BoldItalic | ç²—æ–œä½“æ•°å­¦å˜é‡ | `\boldsymbol{}` æ•°å­¦æ¨¡å¼ |
| **`katex_ams_regular.ttf`** | ams | Regular | é»‘æ¿ç²—ä½“ â„â„•â„¤â„‚ã€AMS æ•°å­¦ç¬¦å· | `\mathbb{}` |

#### å®šç•Œç¬¦å°ºå¯¸å­—ä½“ï¼ˆKaTeX ç‹¬æœ‰ï¼‰

| å­—ä½“æ–‡ä»¶ | æ§½ä½ | æä¾›çš„å­—å½¢ | å¯¹åº”å‘½ä»¤ | è¯´æ˜ |
|---------|------|-----------|---------|------|
| **`katex_size1_regular.ttf`** | size1 | ä¸­å·å®šç•Œç¬¦ `( ) [ ] { } \|` | `\big` | ç‹¬ç«‹è®¾è®¡ï¼Œç¬”ç”»ç²—ç»†ä¸ Main ä¸€è‡´ |
| **`katex_size2_regular.ttf`** | size2 | å¤§å·å®šç•Œç¬¦ | `\Big` | å­—å½¢æ›´å¤§ï¼Œç¬”ç”»ç²—ç»†ä¸å˜ |
| **`katex_size3_regular.ttf`** | size3 | ç‰¹å¤§å·å®šç•Œç¬¦ | `\bigg` | å­—å½¢æ›´å¤§ï¼Œç¬”ç”»ç²—ç»†ä¸å˜ |
| **`katex_size4_regular.ttf`** | size4 | æœ€å¤§å·å®šç•Œç¬¦ã€å¤§å‹è¿ç®—ç¬¦(âˆ‘,âˆ«,âˆ) | `\Bigg` | æœ€å¤§é¢„è®¾å°ºå¯¸ |

**Size å­—ä½“çš„æ ¸å¿ƒä¼˜åŠ¿**ï¼šæ¯ä¸ªå°ºå¯¸çº§åˆ«çš„å­—å½¢ç”±å­—ä½“è®¾è®¡å¸ˆç‹¬ç«‹ç»˜åˆ¶ï¼Œç¬”ç”»ç²—ç»†ç»è¿‡ä¸“é—¨è°ƒæ•´ï¼Œç¡®ä¿åœ¨ä¸åŒå¤§å°ä¸‹è§†è§‰ä¸€è‡´ã€‚è¿™æ¶ˆé™¤äº†æ—§æ–¹æ¡ˆä¸­ fontSize ç¼©æ”¾å¯¼è‡´çš„ç¬”ç”»å˜ç²—é—®é¢˜ï¼Œ**æ— éœ€ FontWeight è¡¥å¿**ã€‚

#### ç‰¹æ®Šæ•°å­¦å­—ä½“

| å­—ä½“æ–‡ä»¶ | æ§½ä½ | æä¾›çš„å­—å½¢ | ç”¨é€” |
|---------|------|-----------|------|
| `katex_sansserif_regular.ttf` | sansSerif (Normal) | æ— è¡¬çº¿æ‹‰ä¸å­—æ¯ | `\mathsf{}` |
| `katex_sansserif_bold.ttf` | sansSerif (Bold) | æ— è¡¬çº¿ç²—ä½“ | `\mathsf{}` ç²—ä½“ |
| `katex_sansserif_italic.ttf` | sansSerif (Italic) | æ— è¡¬çº¿æ–œä½“ | `\mathsf{}` æ–œä½“ |
| `katex_typewriter_regular.ttf` | monospace | ç­‰å®½å­—æ¯ | `\mathtt{}` |
| `katex_caligraphic_regular.ttf` | caligraphic (Normal) | èŠ±ä½“å­—æ¯ | `\mathcal{}` |
| `katex_caligraphic_bold.ttf` | caligraphic (Bold) | èŠ±ä½“ç²—ä½“ | `\mathcal{}` ç²—ä½“ |
| `katex_fraktur_regular.ttf` | fraktur (Normal) | å“¥ç‰¹ä½“ ğ”¤, ğ”°ğ”² | `\mathfrak{}` |
| `katex_fraktur_bold.ttf` | fraktur (Bold) | å“¥ç‰¹ä½“ç²—ä½“ | `\mathfrak{}` ç²—ä½“ |
| `katex_script_regular.ttf` | script | æ‰‹å†™èŠ±ä½“ ğ“›, â„‹ | `\mathscr{}` |

### 9.2 è·¨å¹³å°å­—ä½“å…¼å®¹æ€§

KaTeX å­—ä½“ä½¿ç”¨**æ ‡å‡† Unicode ç ä½**ç¼–ç æ‰€æœ‰å­—å½¢ï¼Œä¸æ—§ CM å­—ä½“ç³»åˆ—ï¼ˆä½¿ç”¨ TeX å†…éƒ¨ç¼–ç ï¼‰æœ‰æœ¬è´¨åŒºåˆ«ï¼š

| ç‰¹æ€§ | KaTeX å­—ä½“ (å½“å‰) | CM å­—ä½“ (å·²å¼ƒç”¨) |
|------|-----------------|-----------------|
| å­—ç¬¦ç¼–ç  | æ ‡å‡† Unicode | TeX å†…éƒ¨ç¼–ç  |
| å¹³å°å…¼å®¹æ€§ | âœ… å…¨å¹³å°ä¸€è‡´ | âŒ `( ) [ ]` åœ¨ JVM/JS/WASM å­—å½¢é”™è¯¯ |
| å®šç•Œç¬¦ç­–ç•¥ | 4 çº§ Size å­—ä½“ï¼Œç‹¬ç«‹è®¾è®¡ | å•ä¸€ cmex10 + fontSize ç¼©æ”¾ |
| å·²çŸ¥ç¼ºé™· | **æ— ** | cmsy10 æ‹¬å·ç±»åœ¨æ¡Œé¢ç«¯è§£ç é”™è¯¯ |

**æ ¸å¿ƒç»“è®º**ï¼šè¿ç§»åˆ° KaTeX å­—ä½“åï¼Œ**ä¸å­˜åœ¨å·²çŸ¥çš„è·¨å¹³å°å­—ä½“æ¸²æŸ“é—®é¢˜**ã€‚`FontResolver` ä¸­æ— éœ€ç»´æŠ¤å¹³å°ç‰¹å®šçš„ `knownDefects` æ˜ å°„è¡¨ã€‚æ‰€æœ‰å¹³å°ï¼ˆAndroidã€iOSã€JVM Desktopã€JS/WASM Webï¼‰å‡èƒ½æ­£ç¡®æ¸²æŸ“æ‰€æœ‰å­—å½¢ã€‚

### 9.3 å®šç•Œç¬¦æ¸²æŸ“ç­–ç•¥ï¼šKaTeX Size å­—ä½“é€çº§é€‰æ‹©

> **æ ¸å¿ƒåŸåˆ™**ï¼šå®šç•Œç¬¦ä½¿ç”¨ **KaTeX Size1~4 å­—ä½“çš„é¢„è®¾å­—å½¢**ï¼Œé¿å… fontSize ç¼©æ”¾å’Œ Path æ‰‹ç»˜ã€‚æ¯çº§ Size å­—ä½“åŒ…å«ç‹¬ç«‹è®¾è®¡çš„å­—å½¢ï¼Œç¬”ç”»ç²—ç»†ä¸€è‡´ï¼Œæ¸²æŸ“è´¨é‡è¿œä¼˜äºç¼©æ”¾æ–¹æ¡ˆã€‚

#### è‡ªåŠ¨ä¼¸ç¼©ç­–ç•¥ï¼ˆ\left...\rightï¼‰

`DelimiterRenderer.measureScaled()` å®ç° 5 çº§é€çº§é€‰æ‹©ï¼š

```kotlin
object DelimiterRenderer {
    /** å®šç•Œç¬¦å°ºå¯¸çº§åˆ« */
    private data class SizeLevel(val name: String, val getFont: (LatexFontFamilies) -> FontFamily)

    private val sizeLevels = listOf(
        SizeLevel("main")  { it.main },
        SizeLevel("size1") { it.size1 },
        SizeLevel("size2") { it.size2 },
        SizeLevel("size3") { it.size3 },
        SizeLevel("size4") { it.size4 },
    )

    fun measureScaled(
        delimiter: String,
        context: RenderContext,
        textMeasurer: TextMeasurer,
        targetHeight: Float,
        density: Density
    ): NodeLayout {
        val fontFamilies = context.fontFamilies ?: return measureText(delimiter, context, textMeasurer)

        // é€çº§å°è¯• Main â†’ Size1 â†’ Size2 â†’ Size3 â†’ Size4
        for (level in sizeLevels) {
            val font = level.getFont(fontFamilies)
            val layout = measureText(delimiter, context.copy(fontFamily = font), textMeasurer)
            if (layout.height >= targetHeight) {
                return layout  // æ‰¾åˆ°æ»¡è¶³é«˜åº¦è¦æ±‚çš„æœ€å°å­—å½¢
            }
        }

        // Size4 ä»ä¸å¤Ÿé«˜ â†’ å¯¹ Size4 åš fontSize ç­‰æ¯”ç¼©æ”¾ï¼ˆæœ€ç»ˆå…œåº•ï¼‰
        val size4Font = fontFamilies.size4
        val size4Layout = measureText(delimiter, context.copy(fontFamily = size4Font), textMeasurer)
        val scale = targetHeight / size4Layout.height
        val scaledContext = context.copy(
            fontFamily = size4Font,
            fontSize = context.fontSize * scale
        )
        return measureText(delimiter, scaledContext, textMeasurer)
    }
}
```

**å…³é”®è®¾è®¡å†³ç­–**ï¼š
- **é€çº§é€‰æ‹©**è€Œéç›´æ¥ç¼©æ”¾ï¼šæ¯çº§ Size å­—ä½“çš„å­—å½¢ç”±è®¾è®¡å¸ˆç‹¬ç«‹ç»˜åˆ¶ï¼Œç¬”ç”»ç²—ç»†ç»è¿‡è°ƒæ•´
- **æ—  FontWeight è¡¥å¿**ï¼šSize å­—ä½“é—´ç¬”ç”»ç²—ç»†å¤©ç„¶ä¸€è‡´ï¼Œä¸éœ€è¦ `compensatedFontWeight()`
- **æ—  Canvas scale å˜æ¢**ï¼šä¸ä½¿ç”¨ `withTransform { scale(scaleX = ...) }` æ¥è¡¥å¿ç¬”ç”»ï¼Œæ¶ˆé™¤äº†æ°´å¹³æ–¹å‘ç¬”ç”»å¤±çœŸ
- **fontSize ç¼©æ”¾ä»…ä½œæœ€ç»ˆå…œåº•**ï¼šä»…å½“ Size4 å­—å½¢ä»ä¸å¤Ÿé«˜æ—¶æ‰ä½¿ç”¨ï¼Œç»å¤§å¤šæ•°åœºæ™¯ä¸ä¼šè§¦å‘

#### æ‰‹åŠ¨å¤§å°å®šç•Œç¬¦ï¼ˆ\big \Big \bigg \Biggï¼‰

ç›´æ¥æ˜ å°„åˆ°å¯¹åº” Size å­—ä½“ï¼Œ**ä¸ç¼©æ”¾ fontSize**ï¼š

```kotlin
// FontResolver ä¸­çš„æ˜ å°„è§„åˆ™
fun manualDelimiterFont(fontFamilies: LatexFontFamilies?, scaleFactor: Float): FontFamily {
    return when {
        scaleFactor <= 1.2f -> fontFamilies?.size1  // \big
        scaleFactor <= 1.8f -> fontFamilies?.size2  // \Big
        scaleFactor <= 2.4f -> fontFamilies?.size3  // \bigg
        else                -> fontFamilies?.size4  // \Bigg
    } ?: FontFamily.Default
}

// DelimiterMeasurer ä¸­çš„ä½¿ç”¨
fun measureManualSizedDelimiter(...): NodeLayout {
    val delimFont = FontResolver.manualDelimiterFont(context.fontFamilies, scaleFactor)
    val delimContext = context.copy(fontFamily = delimFont)
    // ç›´æ¥ç”¨ Size å­—ä½“æµ‹é‡ï¼Œæ— éœ€æ”¾å¤§ fontSize
    val layout = measurer.measure(AnnotatedString(delimChar), delimContext.textStyle())
    // ...
}
```

**vs æ—§æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| ç»´åº¦ | æ—§æ–¹æ¡ˆ (CM å­—ä½“) | æ–°æ–¹æ¡ˆ (KaTeX Size å­—ä½“) |
|------|-----------------|------------------------|
| å­—ä½“æ¥æº | å•ä¸€ cmex10 + fontSize ç¼©æ”¾ | Size1~4 ç‹¬ç«‹å­—å½¢ |
| ç¬”ç”»ç²—ç»† | ç¼©æ”¾å¯¼è‡´å˜ç²—ï¼Œéœ€ FontWeight è¡¥å¿ | å¤©ç„¶ä¸€è‡´ï¼Œæ— éœ€è¡¥å¿ |
| æ¸²æŸ“è´¨é‡ | ä¾èµ– scaleX åå‘è¡¥å¿ï¼Œæœ‰å¤±çœŸ | å­—ä½“å¼•æ“åŸç”Ÿå…‰æ …åŒ–ï¼Œè´¨é‡æœ€ä¼˜ |
| ä»£ç å¤æ‚åº¦ | `compensatedFontWeight()` + `withTransform { scale }` | ç›´æ¥é€‰æ‹©å­—ä½“ï¼Œé€»è¾‘ç®€æ´ |
| å¹³å°ä¸€è‡´æ€§ | cmsy10 æ‹¬å·åœ¨æ¡Œé¢ç«¯æœ‰å­—å½¢é”™è¯¯ | å…¨å¹³å°ä¸€è‡´ |

#### çŸ©é˜µæ‹¬å·ç»Ÿä¸€

çŸ©é˜µç¯å¢ƒï¼ˆpmatrix, bmatrix ç­‰ï¼‰çš„æ‹¬å·ä¸ `\left...\right` å’Œ `\big` ç³»åˆ—å®šç•Œç¬¦ä½¿ç”¨åŒä¸€å¥—æ¸²æŸ“è·¯å¾„ï¼ˆ`DelimiterRenderer.measureScaled()`ï¼‰ï¼Œç¡®ä¿æ‰€æœ‰å®šç•Œç¬¦çš„æ¸²æŸ“æ–¹æ¡ˆç»Ÿä¸€ã€‚

### 9.4 Path ç»˜åˆ¶çš„é€‚ç”¨åœºæ™¯ï¼ˆä¸¥æ ¼é™å®šï¼‰

Path æ‰‹ç»˜**ä»…ç”¨äº**ä»¥ä¸‹ä¸å¯èƒ½é€šè¿‡å­—ä½“è¡¨è¾¾çš„å›¾å½¢ï¼š

| å›¾å½¢ | åŸå›  |
|------|------|
| æ ¹å· âˆš çš„ V å½¢é’© + æ°´å¹³é¡¶çº¿ | æ ¹å·éœ€è¦æ ¹æ®å†…å®¹å®½åº¦åŠ¨æ€å»¶ä¼¸é¡¶çº¿ï¼Œå­—ä½“å­—å½¢æ— æ³•åšåˆ° |
| åˆ†æ•°çº¿ | ç®€å•æ°´å¹³çº¿ï¼ŒdrawLine å³å¯ï¼Œæ— éœ€å­—ä½“ |
| `\overline` / `\underline` | ç®€å•æ°´å¹³çº¿ |
| `\overbrace` / `\underbrace` çš„æ›²çº¿ | éœ€æ ¹æ®å†…å®¹å®½åº¦åŠ¨æ€æ‹‰ä¼¸ï¼Œå­—ä½“å­—å½¢å®½åº¦å›ºå®š |
| `\widehat` / `\widetilde` | éœ€æ ¹æ®å†…å®¹å®½åº¦åŠ¨æ€æ‹‰ä¼¸ |
| å¯ä¼¸ç¼©ç®­å¤´ `\xrightarrow` | ç®­å¤´é•¿åº¦åŠ¨æ€ï¼Œå­—ä½“æ— æ³•è¡¨è¾¾ |
| `\cancel` æ–œçº¿ | ç®€å•æ–œçº¿ |

**åˆ¤æ–­æ ‡å‡†**ï¼šå¦‚æœå›¾å½¢çš„æŸä¸ªç»´åº¦ï¼ˆå®½åº¦æˆ–é«˜åº¦ï¼‰éœ€è¦æ ¹æ®å†…å®¹åŠ¨æ€ä¼¸ç¼©ï¼Œä¸”å­—ä½“å­—å½¢æ— æ³•è¡¨è¾¾è¿™ç§ä¼¸ç¼©æ€§ï¼Œæ‰ä½¿ç”¨ Pathã€‚å¦åˆ™ä¸€å¾‹ä½¿ç”¨å­—ä½“æ¸²æŸ“ã€‚

---

## 10. æ€§èƒ½è§„èŒƒ

### 10.1 Composable å±‚çº§

```kotlin
@Composable
fun Latex(latex: String, config: LatexConfig, ...) {
    // 1. è·å–å¹³å°å·¥å…·ï¼ˆTextMeasurer, Densityï¼‰
    val textMeasurer = rememberTextMeasurer()
    val density = LocalDensity.current

    // 2. å¼‚æ­¥è§£æ
    var document by remember { mutableStateOf<Document?>(null) }
    LaunchedEffect(latex) {
        document = withContext(Dispatchers.Default) { parser.parse(latex) }
    }

    // 3. åŒæ­¥æµ‹é‡ï¼ˆä¾èµ– textMeasurerï¼Œå¿…é¡»åœ¨ Composition ä¸­ï¼‰
    val layout = remember(document, config, density) {
        document?.let { measureGroup(it.children, context, textMeasurer, density) }
    }

    // 4. ç»˜åˆ¶
    layout?.let { lay ->
        Canvas(modifier = Modifier.size(
            width = with(density) { lay.width.toDp() },
            height = with(density) { lay.height.toDp() }
        )) {
            lay.draw(this, 0f, 0f)
        }
    }
}
```

**å…³é”®è®¾è®¡å†³ç­–**ï¼š
- **è§£æ**åœ¨ `Dispatchers.Default` ä¸Šå¼‚æ­¥æ‰§è¡Œï¼ˆCPU å¯†é›†ï¼‰
- **æµ‹é‡**åœ¨ Composition ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œï¼ˆå› ä¸º `TextMeasurer.measure()` éœ€è¦åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œä¸”éœ€è¦ font èµ„æºåŠ è½½å®Œæˆï¼‰
- **ç»˜åˆ¶**æ˜¯çº¯ç²¹çš„ Canvas å›è°ƒï¼Œåªæ‰§è¡Œé¢„è®¡ç®—å¥½çš„ç»˜åˆ¶æŒ‡ä»¤
- `remember` çš„ key æ˜¯ `(document, config, density)`ï¼Œç¡®ä¿è¾“å…¥ä¸å˜æ—¶ä¸é‡æ–°æµ‹é‡

### 10.2 Canvas å°ºå¯¸ä¸å†…è¾¹è·

Canvas å°ºå¯¸ = layout å°ºå¯¸ + å¤–å±‚å†…è¾¹è·ã€‚è¯¦è§ **ç¬¬ 2.4 èŠ‚**ã€‚

- å¿…é¡»ä½¿ç”¨ `Modifier.size(width, height)` æŒ‡å®šç²¾ç¡®å°ºå¯¸
- æ°´å¹³å’Œå‚ç›´æ–¹å‘å‡éœ€æ·»åŠ å†…è¾¹è·ï¼ˆåˆ†åˆ«ä¸º fontSize Ã— 0.15 å’Œ fontSize Ã— 0.10ï¼‰
- **ç¦æ­¢** `fillMaxSize()` / `fillMaxWidth()`ï¼ˆå¯¼è‡´ä¸å¿…è¦çš„å°ºå¯¸å˜åŒ–å’Œé‡ç»˜ï¼‰
- **ç¦æ­¢**ä»…åœ¨æ°´å¹³æ–¹å‘æ·»åŠ  padding è€Œå¿½ç•¥å‚ç›´æ–¹å‘

### 10.3 å¢é‡è§£æ

å¯¹äºæµå¼è¾“å…¥åœºæ™¯ï¼ˆå¦‚é€å­—è¾“å…¥ LaTeXï¼‰ï¼Œè§£æå™¨åº”æ”¯æŒå¢é‡è¿½åŠ ï¼š
- æ–°è¾“å…¥æ˜¯ä¸Šæ¬¡è¾“å…¥çš„å‰ç¼€æ‰©å±• â†’ åªè§£ææ–°å¢éƒ¨åˆ†
- å¦åˆ™ â†’ æ¸…ç©ºé‡æ–°è§£æ
- è§£æç»“æœé€šè¿‡ `mutableStateOf` é©±åŠ¨é‡ç»„

---

## 11. é”™è¯¯å¤„ç†ä¸å®¹é”™

### 11.1 ç©º/å¼‚å¸¸å¸ƒå±€

```kotlin
val EMPTY_LAYOUT = NodeLayout(
    width = 0f, height = 0f, baseline = 0f,
    draw = { _, _ -> }
)
```

ä»»ä½•æµ‹é‡å‡½æ•°åœ¨é‡åˆ°å¼‚å¸¸è¾“å…¥æ—¶ï¼Œè¿”å› `EMPTY_LAYOUT` è€ŒéæŠ›å‡ºå¼‚å¸¸æˆ–è¿”å› nullã€‚

### 11.2 æ•°å€¼å®‰å…¨

æ‰€æœ‰ä»æµ‹é‡ç»“æœå¾—åˆ°çš„æµ®ç‚¹æ•°ï¼Œåœ¨å‚ä¸å¸ƒå±€è®¡ç®—å‰å¿…é¡»é€šè¿‡å®‰å…¨æ£€æŸ¥ï¼š

```kotlin
fun Float.sanitized(fallback: Float = 0f): Float = when {
    isNaN() || isInfinite() -> fallback
    this < 0f -> 0f
    else -> this
}
```

### 11.3 æœªè¯†åˆ«å‘½ä»¤

ä»¥**åŸå§‹æ–‡æœ¬ + é”™è¯¯é¢œè‰²**æ¸²æŸ“ï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°é—®é¢˜æ‰€åœ¨è€Œéç©ºç™½ï¼š

```kotlin
// ä½¿ç”¨ context.errorColorï¼ˆè€Œéç¡¬ç¼–ç  Color.Redï¼‰
val errorStyle = context.textStyle().copy(color = context.errorColor)
```

---

## 12. ä»£ç ç»„ç»‡

### 12.1 Measurer èŒè´£åˆ’åˆ†

æ¯ä¸ª Measurer è´Ÿè´£ä¸€ç±» AST èŠ‚ç‚¹çš„æµ‹é‡ + ç»˜åˆ¶æŒ‡ä»¤ç”Ÿæˆï¼š

| Measurer | è´Ÿè´£çš„ LaTeX ç»“æ„ |
|----------|------------------|
| TextContentMeasurer | æ™®é€šæ–‡æœ¬ã€ç¬¦å·ã€è¿ç®—ç¬¦ã€ç©ºç™½ |
| MathMeasurer | åˆ†æ•°ã€æ ¹å·ã€ä¸Šä¸‹æ ‡ã€å¤§å‹è¿ç®—ç¬¦ |
| MatrixMeasurer | çŸ©é˜µã€æ•°ç»„ã€casesã€aligned |
| DelimiterMeasurer | \left \right è‡ªåŠ¨ä¼¸ç¼©ã€\big \Big ç­‰æ‰‹åŠ¨å¤§å° |
| AccentMeasurer | \hat \vec \overline \underbrace ç­‰è£…é¥° |
| StackMeasurer | \overset \underset \stackrel |
| ExtensibleArrowMeasurer | \xrightarrow \xleftarrow |
| SpecialEffectMeasurer | \boxed \phantom \cancel |

### 12.2 Measurer æ¥å£

```kotlin
interface NodeMeasurer<T : LatexNode> {
    fun measure(
        node: T,
        context: RenderContext,
        measurer: TextMeasurer,
        density: Density,
        measureNode: (LatexNode, RenderContext) -> NodeLayout,    // é€’å½’æµ‹é‡å•èŠ‚ç‚¹
        measureGroup: (List<LatexNode>, RenderContext) -> NodeLayout  // é€’å½’æµ‹é‡èŠ‚ç‚¹åˆ—è¡¨
    ): NodeLayout
}
```

`measureNode` å’Œ `measureGroup` ä½œä¸ºå‡½æ•°å‚æ•°æ³¨å…¥ï¼Œå®ç° Measurer é—´çš„è§£è€¦ã€‚æ¯ä¸ª Measurer ä¸ç›´æ¥å¼•ç”¨å…¶ä»– Measurerã€‚

### 12.3 å‘½åçº¦å®š

```kotlin
// æµ‹é‡å…¥å£
fun measure[ç»“æ„å](node, context, ...): NodeLayout

// Path å·¥å‚
fun create[å›¾å½¢å]Path(å‚æ•°...): Path

// é—´è·/å°ºå¯¸è®¡ç®—
fun compute[å±æ€§å](context): Float

// æ ·å¼å˜ä½“
fun RenderContext.with[å˜åŒ–](): RenderContext   // å¦‚ withScriptStyle(), withBoldWeight()
```

---

## 13. å¼€å‘æ£€æŸ¥æ¸…å•

æ¯æ¬¡æ–°å¢æˆ–ä¿®æ”¹ç»˜åˆ¶åŠŸèƒ½ï¼Œé€é¡¹æ£€æŸ¥ï¼š

- [ ] **è¾¹ç•Œå®‰å…¨**ï¼šNodeLayout.width/height åŒ…å«æ‰€æœ‰å¢¨æ°´ï¼ˆStroke åŠå®½ã€æ–œä½“æ‚¬ä¼¸ã€glyph å®é™…èŒƒå›´ï¼‰
- [ ] **è¾¹ç•Œå®‰å…¨**ï¼šæ–œä½“è¡¥å¿ä½¿ç”¨ px å•ä½ï¼ˆ`density.toPx()`ï¼‰ï¼Œè€Œé sp çš„ `.value`
- [ ] **è¾¹ç•Œå®‰å…¨**ï¼šscale å˜æ¢åçš„ height åæ˜ ç¼©æ”¾åçš„å®é™…é«˜åº¦
- [ ] **è¾¹ç•Œå®‰å…¨**ï¼šå¤–å±‚ Canvas æ°´å¹³å’Œå‚ç›´æ–¹å‘å‡æœ‰å†…è¾¹è·
- [ ] draw lambda ä¸­æ— æµ‹é‡è°ƒç”¨ã€æ— å¯¹è±¡åˆ†é…ã€æ— å¹³å°åˆ†æ”¯
- [ ] Path ä»¥ (0,0) ä¸ºåŸç‚¹æ„å»ºï¼Œdraw æ—¶é€šè¿‡ translate åç§»
- [ ] æ°´å¹³æ’åˆ—ä½¿ç”¨åŸºçº¿å¯¹é½ï¼ˆéé¡¶éƒ¨/ä¸­å¿ƒå¯¹é½ï¼‰
- [ ] æ•°å­¦ç»“æ„ä»¥æ•°å­¦è½´ä¸ºä¸­å¿ƒï¼ˆåˆ†æ•°çº¿ã€å¤§å‹è¿ç®—ç¬¦ï¼‰
- [ ] é—´è·é€šè¿‡ `MathSpacing.spaceBetween()` è®¡ç®—ï¼Œæ— é­”æ³•æ•°å­—
- [ ] é¢œè‰²æ¥è‡ª `RenderContext`ï¼Œæ— ç¡¬ç¼–ç  `Color.Xxx`
- [ ] å­—ä½“é€šè¿‡ `FontResolver` è·¯ç”±è·å–ï¼Œæ— åˆ†æ•£çš„å­—ä½“é€‰æ‹©é€»è¾‘
- [ ] å®šç•Œç¬¦ä½¿ç”¨ KaTeX Size1~4 å­—ä½“é€çº§é€‰æ‹©ï¼ˆä»… Size4 ä»ä¸å¤Ÿæ—¶æ‰ fontSize ç¼©æ”¾å…œåº•ï¼‰
- [ ] æ‰‹åŠ¨å¤§å°å®šç•Œç¬¦ï¼ˆ`\big` ç­‰ï¼‰ç›´æ¥ä½¿ç”¨å¯¹åº” Size å­—ä½“ï¼Œä¸ç¼©æ”¾ fontSize
- [ ] ä¸Šä¸‹æ ‡ä½¿ç”¨ `MathStyle` ç¼©æ”¾ï¼Œè€Œéç›´æ¥ä¿®æ”¹ fontSize
- [ ] ç©ºè¾“å…¥è¿”å› `EMPTY_LAYOUT`ï¼Œä¸æŠ›å¼‚å¸¸
- [ ] æµ®ç‚¹æ•°ç»è¿‡ `sanitized()` æ£€æŸ¥
- [ ] `remember` çš„ key æ˜¯è¾“å…¥æ•°æ®ï¼ˆAST + configï¼‰ï¼Œä¸æ˜¯ layout æœ¬èº«
- [ ] Canvas ä½¿ç”¨ç²¾ç¡® `Modifier.size()`
- [ ] åœ¨ Android / iOS / Desktop(JVM) ä¸‰ç«¯éªŒè¯æ¸²æŸ“ä¸€è‡´